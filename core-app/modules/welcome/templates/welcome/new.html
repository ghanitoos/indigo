{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h3>Willkommensseite - Neuer Mitarbeiter</h3>
  <div class="mb-3">
    <label for="ldap-q" class="form-label">Suche (username oder email)</label>
    <input id="ldap-q" class="form-control" placeholder="z.B. jthiede" autocomplete="off" />
    <div id="ldap-suggestions" class="list-group mt-1" style="position:relative; z-index:2000;"></div>
  </div>

  <form id="welcome-form">
    <div class="row">
      <div class="col-md-6">
        <label class="form-label">Vorname</label>
        <input id="first_name" name="first_name" class="form-control" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Nachname</label>
        <input id="last_name" name="last_name" class="form-control" />
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-md-6">
        <label class="form-label">Herr/Frau</label>
        <select id="gender" name="gender" class="form-select">
          <option value="Herr">Herr</option>
          <option value="Frau">Frau</option>
          <option value="Divers">Divers</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">E-Mail</label>
        <input id="email" name="email" class="form-control" />
      </div>
    </div>

    <div class="mt-3">
      <h5>Generierte Zugangsdaten</h5>
      <pre id="out-result"></pre>
    </div>

    <div class="mt-3 no-print">
      <button id="btn-generate" class="btn btn-success" type="button">Generiere Passwörter</button>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Autocomplete: debounce input and query /welcome/search for suggestions
;(function(){
  var inp = document.getElementById('ldap-q');
  var list = document.getElementById('ldap-suggestions');
  var timer = null;

  function clearList(){ list.innerHTML = ''; }

  function renderSuggestions(items){
    clearList();
    if (!items || items.length === 0) return;
    items.slice(0,20).forEach(function(it){
      var a = document.createElement('button');
      a.type = 'button';
      a.className = 'list-group-item list-group-item-action';
      a.textContent = (it.username || '') + (it.email ? ' — ' + it.email : '');
      a.dataset.username = it.username || '';
      a.dataset.first_name = it.first_name || '';
      a.dataset.last_name = it.last_name || '';
      a.dataset.email = it.email || '';
      a.addEventListener('click', function(){
        document.getElementById('first_name').value = this.dataset.first_name;
        document.getElementById('last_name').value = this.dataset.last_name;
        document.getElementById('email').value = this.dataset.email;
        window.__welcome_username = this.dataset.username || (this.dataset.email || '').split('@')[0];
        inp.value = this.dataset.username || this.dataset.email || inp.value;
        clearList();
      });
      list.appendChild(a);
    });
  }

  inp.addEventListener('input', function(){
    var q = inp.value.trim();
    if (timer) clearTimeout(timer);
    if (!q || q.length < 2) { clearList(); return; }
    timer = setTimeout(function(){
      fetch('/welcome/search?q=' + encodeURIComponent(q)).then(function(r){
        if (!r.ok) return [];
        return r.json();
      }).then(function(data){ renderSuggestions(data || []); }).catch(function(){ clearList(); });
    }, 250);
  });

  // close suggestions when clicking outside
  document.addEventListener('click', function(ev){ if (!inp.contains(ev.target) && !list.contains(ev.target)) clearList(); });
})();

document.getElementById('btn-generate').addEventListener('click', function(){
  var username = window.__welcome_username || document.getElementById('email').value.split('@')[0] || '';
  var first = document.getElementById('first_name').value || '';
  var last = document.getElementById('last_name').value || '';
  fetch('/welcome/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username: username, first_name: first, last_name: last})}).then(function(r){ return r.json(); }).then(function(j){
    var out = 'PC:\nUser: ' + username + '\nPassword: ' + j.pc_password + '\n\n';
    out += 'E-Mail:\nBenutzername: ' + (document.getElementById('email').value || '') + '\nPassword: ' + j.email_password + '\n\n';
    out += 'Cloud:\nBenutzername: ' + username + '\nPassword: ' + j.cloud_password + '\n';
    document.getElementById('out-result').textContent = out;
  });
});
</script>
{% endblock %}
